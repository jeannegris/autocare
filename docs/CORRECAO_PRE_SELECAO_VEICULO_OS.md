# Corre√ß√£o: Pr√©-sele√ß√£o de Ve√≠culo na Ordem de Servi√ßo

## üìã Problema Identificado

Data: 15 de outubro de 2025

### Descri√ß√£o do Bug
Quando o usu√°rio cria uma nova Ordem de Servi√ßo atrav√©s da busca por placa do ve√≠culo:
1. Digita a placa do ve√≠culo (ex: KVS-7I59)
2. Sistema encontra o ve√≠culo e seu propriet√°rio
3. Usu√°rio clica em **"Sim, √© o mesmo"**
4. **PROBLEMA**: No formul√°rio da OS, aparece **outro ve√≠culo** do mesmo cliente em vez do ve√≠culo buscado

### Cen√°rio de Teste
- **Cliente**: Jean Negris (possui 2 ve√≠culos)
  - Ve√≠culo 1: KIA CERATO - KVS-7I59
  - Ve√≠culo 2: FORD FIESTA - LUN-5874
  
- **A√ß√£o**: Buscar por placa **KVS-7I59**
- **Resultado Esperado**: Formul√°rio deve abrir com **KIA CERATO - KVS-7I59** pr√©-selecionado
- **Resultado Anterior**: Formul√°rio abria com **FORD FIESTA - LUN-5874** (primeiro ve√≠culo da lista)

---

## üîç Causa Raiz

### Fluxo Anterior (Incorreto)
```
1. Usu√°rio busca placa ‚Üí KVS-7I59
2. Sistema encontra ve√≠culo e propriet√°rio
3. Usu√°rio confirma: "Sim, √© o mesmo"
4. Callback: onClienteEncontrado(cliente) ‚Üê ‚ùå S√ì PASSA O CLIENTE
5. Modal Nova OS: usa primeiro ve√≠culo da lista ‚Üê ‚ùå IGNORA A PLACA BUSCADA
```

### Problema no C√≥digo

**ModalBuscaClienteVeiculo.tsx** (Linha ~95):
```tsx
const handleConfirmarProprietario = () => {
  if (resultadoVeiculo?.cliente) {
    onClienteEncontrado(resultadoVeiculo.cliente);  // ‚ùå N√£o passa o ve√≠culo!
    onClose();
  }
};
```

**ModalNovaOrdem.tsx** (Linha ~80):
```tsx
setFormData(prev => ({
  ...prev,
  cliente_id: clienteParaProcessar.id,
  veiculo_id: clienteParaProcessar.veiculos[0].id  // ‚ùå Sempre pega o primeiro!
}));
```

---

## ‚úÖ Solu√ß√£o Implementada

### Altera√ß√µes Realizadas

#### 1. Interface `ModalBuscaClienteVeiculoProps`
**Arquivo**: `/var/www/autocare/frontend/src/components/ModalBuscaClienteVeiculo.tsx`

```tsx
// ANTES
onClienteEncontrado: (cliente: ClienteBuscaResponse['cliente']) => void;

// DEPOIS
onClienteEncontrado: (
  cliente: ClienteBuscaResponse['cliente'], 
  veiculoPreSelecionado?: VeiculoBuscaResponse['veiculo']
) => void;
```

**Impacto**: Agora a fun√ß√£o pode receber o ve√≠culo que deve ser pr√©-selecionado.

#### 2. Fun√ß√£o `handleConfirmarProprietario`
**Arquivo**: `/var/www/autocare/frontend/src/components/ModalBuscaClienteVeiculo.tsx`

```tsx
// ANTES
const handleConfirmarProprietario = () => {
  if (resultadoVeiculo?.cliente) {
    onClienteEncontrado(resultadoVeiculo.cliente);
    onClose();
  }
};

// DEPOIS
const handleConfirmarProprietario = () => {
  if (resultadoVeiculo?.cliente) {
    // Passar o ve√≠culo encontrado pela placa como pr√©-selecionado
    onClienteEncontrado(resultadoVeiculo.cliente, resultadoVeiculo.veiculo);
    onClose();
  }
};
```

**Impacto**: Agora passa o ve√≠culo correto junto com o cliente.

#### 3. Sele√ß√£o de Ve√≠culo ao Buscar Cliente
**Arquivo**: `/var/www/autocare/frontend/src/components/ModalBuscaClienteVeiculo.tsx` (Linha ~350)

```tsx
// ANTES
onClick={() => {
  const clienteComVeiculo = {
    ...resultadoCliente.cliente!,
    veiculos: [veiculo]
  };
  onClienteEncontrado(clienteComVeiculo);
  onClose();
}}

// DEPOIS
onClick={() => {
  // Passar o ve√≠culo selecionado como segundo par√¢metro
  onClienteEncontrado(resultadoCliente.cliente!, veiculo);
  onClose();
}}
```

**Impacto**: Quando o usu√°rio busca por cliente e seleciona um ve√≠culo, tamb√©m passa o ve√≠culo correto.

#### 4. Fun√ß√£o `handleClienteEncontrado`
**Arquivo**: `/var/www/autocare/frontend/src/pages/OrdensServico.tsx`

```tsx
// ANTES
const handleClienteEncontrado = (cliente: ClienteBuscaResponse['cliente']) => {
  setClienteSelecionado(cliente);
  setModalOrdem(true);
};

// DEPOIS
const handleClienteEncontrado = (
  cliente: ClienteBuscaResponse['cliente'], 
  veiculoPreSelecionado?: VeiculoBuscaResponse['veiculo']
) => {
  setClienteSelecionado(cliente);
  // Se um ve√≠culo foi pr√©-selecionado (busca por placa), defini-lo
  if (veiculoPreSelecionado) {
    setVeiculoSelecionado(veiculoPreSelecionado);
  }
  setModalOrdem(true);
};
```

**Impacto**: Agora armazena o ve√≠culo pr√©-selecionado no estado.

#### 5. Interface `ModalNovaOrdemProps`
**Arquivo**: `/var/www/autocare/frontend/src/components/ModalNovaOrdem.tsx`

```tsx
// ANTES
interface ModalNovaOrdemProps {
  isOpen: boolean;
  onClose: () => void;
  cliente: ClienteBuscaResponse['cliente'];
  onSuccess: () => void;
}

// DEPOIS
interface ModalNovaOrdemProps {
  isOpen: boolean;
  onClose: () => void;
  cliente: ClienteBuscaResponse['cliente'];
  onSuccess: () => void;
  veiculoPreSelecionado?: any; // Ve√≠culo j√° selecionado (busca por placa)
}
```

**Impacto**: Modal de nova ordem agora recebe o ve√≠culo pr√©-selecionado.

#### 6. UseEffect no ModalNovaOrdem
**Arquivo**: `/var/www/autocare/frontend/src/components/ModalNovaOrdem.tsx` (Linha ~70)

```tsx
// ANTES
setFormData(prev => ({
  ...prev,
  cliente_id: clienteParaProcessar.id,
  veiculo_id: clienteParaProcessar.veiculos[0].id
}));

// DEPOIS
// Definir ve√≠culo: priorizar ve√≠culo pr√©-selecionado, sen√£o usar o primeiro da lista
let veiculoId = null;
if (veiculoPreSelecionado && veiculoPreSelecionado.id) {
  // Usar ve√≠culo pr√©-selecionado (busca por placa)
  veiculoId = veiculoPreSelecionado.id;
} else if (clienteParaProcessar.veiculos && clienteParaProcessar.veiculos.length > 0) {
  // Usar primeiro ve√≠culo da lista
  veiculoId = clienteParaProcessar.veiculos[0].id;
}

setFormData(prev => ({
  ...prev,
  cliente_id: clienteParaProcessar.id,
  veiculo_id: veiculoId
}));
```

**Impacto**: Agora prioriza o ve√≠culo pr√©-selecionado sobre o primeiro da lista.

#### 7. Passagem do Ve√≠culo no Render
**Arquivo**: `/var/www/autocare/frontend/src/pages/OrdensServico.tsx` (Linha ~649)

```tsx
// ANTES
<ModalNovaOrdem
  isOpen={modalOrdem}
  onClose={() => {
    setModalOrdem(false);
    setClienteSelecionado(null);
  }}
  cliente={clienteSelecionado}
  onSuccess={handleOrdemCriada}
/>

// DEPOIS
<ModalNovaOrdem
  isOpen={modalOrdem}
  onClose={() => {
    setModalOrdem(false);
    setClienteSelecionado(null);
    setVeiculoSelecionado(null); // Limpar ve√≠culo selecionado
  }}
  cliente={clienteSelecionado}
  onSuccess={handleOrdemCriada}
  veiculoPreSelecionado={veiculoSelecionado}
/>
```

**Impacto**: Passa o ve√≠culo selecionado para o modal e limpa ao fechar.

---

## üéØ Fluxo Corrigido

### Busca por Placa
```
1. Usu√°rio busca placa ‚Üí KVS-7I59
2. Sistema encontra ve√≠culo + propriet√°rio
3. Usu√°rio confirma: "Sim, √© o mesmo"
4. Callback: onClienteEncontrado(cliente, veiculo) ‚Üê ‚úÖ PASSA AMBOS
5. Estado: setVeiculoSelecionado(veiculo) ‚Üê ‚úÖ ARMAZENA VE√çCULO
6. Modal Nova OS: usa veiculoPreSelecionado ‚Üê ‚úÖ CORRETO!
```

### Busca por Cliente
```
1. Usu√°rio busca CPF/telefone
2. Sistema encontra cliente com m√∫ltiplos ve√≠culos
3. Usu√°rio seleciona ve√≠culo espec√≠fico
4. Callback: onClienteEncontrado(cliente, veiculo) ‚Üê ‚úÖ PASSA AMBOS
5. Estado: setVeiculoSelecionado(veiculo) ‚Üê ‚úÖ ARMAZENA VE√çCULO
6. Modal Nova OS: usa veiculoPreSelecionado ‚Üê ‚úÖ CORRETO!
```

---

## üìä Arquivos Modificados

1. **`/var/www/autocare/frontend/src/components/ModalBuscaClienteVeiculo.tsx`**
   - Interface `ModalBuscaClienteVeiculoProps`
   - Fun√ß√£o `handleConfirmarProprietario`
   - Sele√ß√£o de ve√≠culo ao buscar por cliente

2. **`/var/www/autocare/frontend/src/pages/OrdensServico.tsx`**
   - Fun√ß√£o `handleClienteEncontrado`
   - Passagem do `veiculoPreSelecionado` para `ModalNovaOrdem`
   - Limpeza do `veiculoSelecionado` ao fechar modal

3. **`/var/www/autocare/frontend/src/components/ModalNovaOrdem.tsx`**
   - Interface `ModalNovaOrdemProps`
   - Par√¢metro `veiculoPreSelecionado`
   - UseEffect para priorizar ve√≠culo pr√©-selecionado

---

## üß™ Como Testar

### Teste 1: Busca por Placa
1. Acesse **Ordens de Servi√ßo**
2. Clique em **"+ Nova OS"**
3. Selecione busca por **"Placa"**
4. Digite: **KVS-7I59**
5. Clique em **Buscar** üîç
6. Verifique: Sistema encontra **KIA CERATO**
7. Clique em **"‚úì Sim, √© o mesmo"**
8. **Verifique**: Combobox de ve√≠culo deve mostrar **KIA CERATO - KVS7I59** selecionado ‚úÖ

### Teste 2: Busca por Cliente com M√∫ltiplos Ve√≠culos
1. Acesse **Ordens de Servi√ßo**
2. Clique em **"+ Nova OS"**
3. Busque por CPF: **088.908.967-10**
4. Sistema mostra Jean Negris com 2 ve√≠culos
5. Clique no **segundo ve√≠culo** (FORD FIESTA)
6. **Verifique**: Combobox deve mostrar **FORD FIESTA - LUN5874** selecionado ‚úÖ

### Teste 3: Busca por Cliente com 1 Ve√≠culo
1. Busque um cliente com apenas 1 ve√≠culo
2. **Verifique**: Ve√≠culo √∫nico √© selecionado automaticamente ‚úÖ

---

## üéØ Benef√≠cios

### Para o Usu√°rio
- ‚úÖ **Menos cliques**: N√£o precisa trocar o ve√≠culo manualmente
- ‚úÖ **Menos erros**: Sistema seleciona o ve√≠culo correto automaticamente
- ‚úÖ **Mais r√°pido**: Fluxo mais eficiente de cria√ß√£o de OS
- ‚úÖ **Intuitivo**: Comportamento esperado funciona corretamente

### Para o Sistema
- ‚úÖ **Consist√™ncia**: Busca por placa agora funciona como esperado
- ‚úÖ **Confiabilidade**: Reduz risco de erro humano
- ‚úÖ **C√≥digo limpo**: Solu√ß√£o elegante e bem tipada
- ‚úÖ **Manuten√≠vel**: F√°cil entender o fluxo de dados

---

## üìù Casos de Uso Corrigidos

| Cen√°rio | Antes | Depois |
|---------|-------|--------|
| Busca por placa (cliente com 2+ ve√≠culos) | ‚ùå Seleciona 1¬∫ ve√≠culo | ‚úÖ Seleciona ve√≠culo buscado |
| Busca por cliente ‚Üí seleciona ve√≠culo | ‚ùå Solu√ß√£o workaround | ‚úÖ Solu√ß√£o nativa |
| Busca por placa (cliente com 1 ve√≠culo) | ‚úÖ Funciona | ‚úÖ Continua funcionando |
| Busca por cliente (1 ve√≠culo) | ‚úÖ Funciona | ‚úÖ Continua funcionando |

---

## üîß Detalhes T√©cnicos

### Tipagem TypeScript
```typescript
// Interface atualizada com segundo par√¢metro opcional
onClienteEncontrado: (
  cliente: ClienteBuscaResponse['cliente'], 
  veiculoPreSelecionado?: VeiculoBuscaResponse['veiculo']
) => void;
```

### Prioridade de Sele√ß√£o
```typescript
let veiculoId = null;

// 1¬™ prioridade: Ve√≠culo pr√©-selecionado pela busca
if (veiculoPreSelecionado && veiculoPreSelecionado.id) {
  veiculoId = veiculoPreSelecionado.id;
}
// 2¬™ prioridade: Primeiro ve√≠culo da lista
else if (clienteParaProcessar.veiculos?.length > 0) {
  veiculoId = clienteParaProcessar.veiculos[0].id;
}
```

### Estado do Ve√≠culo
```typescript
const [veiculoSelecionado, setVeiculoSelecionado] = useState<...>(null);

// Definir ao encontrar cliente
setVeiculoSelecionado(veiculoPreSelecionado);

// Limpar ao fechar modal
setVeiculoSelecionado(null);
```

---

## üöÄ Impacto

### Sem Breaking Changes
- ‚úÖ Par√¢metro `veiculoPreSelecionado` √© **opcional**
- ‚úÖ C√≥digo existente continua funcionando
- ‚úÖ Apenas adiciona funcionalidade nova
- ‚úÖ Backward compatible

### Casos de Uso Mantidos
- ‚úÖ Cliente sem ve√≠culo ‚Üí continua funcionando
- ‚úÖ VENDA (sem ve√≠culo) ‚Üí n√£o afetado
- ‚úÖ Cadastro de novo ve√≠culo ‚Üí n√£o afetado

---

## üìû Suporte

- **Arquivos modificados**: 3 arquivos TypeScript
- **Linhas alteradas**: ~50 linhas
- **Complexidade**: Baixa
- **Risco**: M√≠nimo (opcional + backward compatible)

---

**Corrigido em**: 15/10/2025  
**Status**: ‚úÖ Implementado e Testado  
**Vers√£o**: 1.0  
**Prioridade**: Alta (bug cr√≠tico de UX)  
**Impacto**: Melhoria significativa na experi√™ncia do usu√°rio
