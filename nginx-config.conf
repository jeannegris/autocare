map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
 listen 80 default_server;
 server_name 167.234.236.80;

 root /var/www/html;
 index index.html;

 # PÃ¡gina raiz simples
 location = / {
        return 200 'Servidor ativo';
        add_header Content-Type text/plain;
 }

 # Projeto React - BKAutoCenter
 location /bkautocenter/ {
        try_files $uri /bkautocenter/index.html;
 }

 # ðŸš— NOVO: Projeto React - AutoCenter
 location /autocare/ {
        alias /var/www/autocare/frontend/dist/;
        index index.html;
        try_files $uri $uri/ /autocare/index.html;
        access_log /var/log/nginx/autocare.access.log;
        error_log /var/log/nginx/autocare.error.log warn;
 }

# Opcional: normalizar /autocare -> /autocare/
 location = /autocare {
        return 301 /autocare/;
}

 # API existente (porta 8000)
 location /api/ {
        proxy_pass http://127.0.0.1:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Adicionar cabeÃ§alhos CORS
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, DELETE, PUT";
        add_header Access-Control-Allow-Headers "Authorization, Content-Type";
 }

 # ðŸš— NOVO: API AutoCenter (porta 8008)
  location /autocare-api/ {
        # Encaminhar para o backend incluindo o prefixo /api/ para casar com as rotas do FastAPI
        proxy_pass http://127.0.0.1:8008/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
       # Informar prefixo externo ao backend e reescrever Location retornadas
        proxy_set_header X-Forwarded-Prefix /autocare-api;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect ~^https?://[^/]+/api/(.*) /autocare-api/$1;
        proxy_redirect /api/ /autocare-api/;

        # Adicionar cabeÃ§alhos CORS
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, DELETE, PUT" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

        # Responder preflight rapidamente
        if ($request_method = 'OPTIONS') {
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
 }

 # ðŸš— NOVO: DocumentaÃ§Ã£o da API AutoCenter
 location /autocare-docs/ {
        proxy_pass http://127.0.0.1:8008/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Remover sufixo da URL para o backend
        rewrite ^/autocare-docs/(.*)$ /docs/$1 break;
 }

 # ðŸš— NOVO: Health check AutoCenter
 location /autocare-health {
        proxy_pass http://127.0.0.1:8008/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
 }

}