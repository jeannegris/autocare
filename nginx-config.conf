map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80 default_server;
    server_name 167.234.236.80;

    root /var/www/html;
    index index.html;

    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, DELETE, PUT" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

    location = / {
        return 200 'Servidor ativo';
        add_header Content-Type text/plain;
    }

    ##########################################################
    # FRONTENDS
    ##########################################################

    location /bkautocenter/ { alias /var/www/bkautocenter/frontend/dist/; try_files $uri $uri/ /bkautocenter/index.html; }
    location /gpac/         { alias /var/www/gpac/frontend/dist/;         try_files $uri $uri/ /gpac/index.html; }
    location /aguanaboca/   { alias /var/www/aguanaboca/frontend/dist/;   try_files $uri $uri/ /aguanaboca/index.html; }
    location /equora/       { alias /var/www/equora/frontend/dist/;       try_files $uri $uri/ /equora/index.html; }
    location /newsday/      { alias /var/www/newsday/frontend/dist/;      try_files $uri $uri/ /newsday/index.html; }
    location /niveldomar/   { alias /var/www/niveldomar/frontend/dist/;   try_files $uri $uri/ /niveldomar/index.html; }
    location /autocare/     { alias /var/www/autocare/frontend/dist/;     try_files $uri $uri/ /autocare/index.html; }
    location /bets/         { alias /var/www/bets/frontend/dist/;         try_files $uri $uri/ /bets/index.html; }

    location /bets/logos/ { alias /var/www/bets/frontend/public/logos/; access_log off; expires 30d; add_header Cache-Control "public, immutable"; }
    location /bets/assets/ { alias /var/www/bets/frontend/dist/assets/; access_log off; add_header Cache-Control "no-cache, no-store, must-revalidate"; add_header Access-Control-Allow-Origin * always; }

    location = /bets { return 301 /bets/; }

    ##########################################################
    # APIS
    ##########################################################

    location /api/           { proxy_pass http://127.0.0.1:8000/api/; include /etc/nginx/proxy_params; }
    location /niveldomar-api/ { proxy_pass http://127.0.0.1:8001/;     include /etc/nginx/proxy_params; }

    location /autocare-api/ {
        # Normalizar trailing slash apenas para GET (evita 307 sem quebrar POST/PUT/DELETE)
        # Apenas para caminhos de primeiro nível (ex.: /autocare-api/clientes),
        # evitar aplicar em subcaminhos (ex.: /autocare-api/dashboard/resumo)
        if ($request_method = 'GET') {
            rewrite ^(/autocare-api/[^/]+)$ $1/ break;
        }

        # Encaminhamento mínimo e estável para o backend do AutoCare
        proxy_pass http://127.0.0.1:8008;
        include /etc/nginx/proxy_params;

        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, DELETE, PUT" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    location ~ ^/bets-api/(teams|matches|competitions|statistics)$ {
        rewrite ^/bets-api/(teams|matches|competitions|statistics)$ /bets-api/$1/ permanent;
    }

    location /bets-api/ {
        proxy_pass http://127.0.0.1:8007/api/v1/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /bets-api;

        proxy_redirect ~^(.*/)?api/v1/(.*)$ /bets-api/$2;
        proxy_redirect default;

        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, DELETE, PUT" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    ##########################################################
    # DOCS
    ##########################################################

    location /niveldomar-docs/ { rewrite ^/niveldomar-docs/(.*)$ /docs/$1 break; proxy_pass http://127.0.0.1:8001/docs; include /etc/nginx/proxy_params; }
    location /autocare-docs/   { rewrite ^/autocare-docs/(.*)$ /docs/$1 break; proxy_pass http://127.0.0.1:8008/docs; include /etc/nginx/proxy_params; }
    location /bets-docs/       { rewrite ^/bets-docs/(.*)$ /docs/$1 break; proxy_pass http://127.0.0.1:8007/docs; include /etc/nginx/proxy_params; }
    location /bets-redoc/      { rewrite ^/bets-redoc/(.*)$ /redoc/$1 break; proxy_pass http://127.0.0.1:8007/redoc; include /etc/nginx/proxy_params; }

    ##########################################################
    # HEALTH CHECKS
    ##########################################################

    location /niveldomar-health { proxy_pass http://127.0.0.1:8001/health; }
    location /autocare-health   { proxy_pass http://127.0.0.1:8008/health; }
    location /bets-health       { proxy_pass http://127.0.0.1:8007/health; add_header Cache-Control "no-cache, no-store, must-revalidate"; }

    ##########################################################
    # EXTRA
    ##########################################################

    location /libretranslate/ { proxy_pass http://127.0.0.1:5000/; include /etc/nginx/proxy_params; }
}
